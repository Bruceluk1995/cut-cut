# TikTok视频混剪工具实现文档

## 1. 核心功能实现

### 1.1 GUI界面功能
- [x] 文件夹选择区域
  - 输入文件夹选择和显示
  - 输出文件夹选择和显示
  - 实时路径验证和更新
  - 快速打开文件夹功能

- [x] 参数设置区域
  - 手动模式参数设置
    - 片段时长设置
    - 片段数量设置
    - 总时长计算
  - 自动模式参数设置
    - 目标总时长设置
    - 自动计算片段参数
  - 生成数量设置
  - 输出文件名设置

- [x] 视频列表区域
  - 视频文件显示
  - 选择状态切换
  - 全选/取消全选功能
  - 双击预览视频

- [x] 开始混剪按钮
  - 黑色文字，绿色背景
  - 处理状态显示
  - 多线程处理避免GUI卡顿

### 1.2 视频处理功能
- [x] 视频尺寸调整
  - 自动调整至1080x1920
  - 智能背景填充
  - 保持原始比例

- [x] 视频片段处理
  - 随机选择视频片段
  - 自定义片段时长
  - 自动计算片段参数
  - 批量生成功能

- [x] 视频合并功能
  - 自动合并选中片段
  - 保持视频质量
  - 自动文件名管理
  - 防止文件名冲突

### 1.3 音频处理功能
- [x] 音频模式选择
  - 保留原始音频
  - 仅保留人声（去除背景音乐）
  - 完全去除音频
  - 模式互斥控制

- [x] 背景音乐功能
  - 音乐池管理
    - 添加/删除音乐池
    - 自定义音乐池名称
    - 音乐池列表显示
    - 多选删除支持
  - 音乐文件管理
    - 音乐文件列表显示
    - 音乐时长显示
    - 选择状态管理
  - 背景音乐模式
    - 跟随视频模式（循环或裁剪）
    - 跟随音乐模式（视频速度自适应）
  - 音量控制
    - 背景音乐音量自动调整

### 1.4 配置管理
- [x] 配置文件存储
  - JSON格式配置文件
  - 自动保存配置
  - 定时配置更新
  - UTF-8编码支持

- [x] 状态保存
  - 输入/输出路径
  - 音乐池配置
  - 音乐选择状态
  - 参数设置状态

### 1.5 用户体验优化
- [x] 实时更新
  - 文件夹状态检查
  - 音乐池状态更新
  - 配置自动保存
  - 界面实时刷新

- [x] 错误处理
  - 输入验证
  - 错误提示
  - 异常处理
  - 用户友好提示

- [x] 操作便捷性
  - 快速打开文件夹
  - 拖拽支持
  - 快捷键支持
  - 批量操作支持

## 2. 技术实现细节

### 2.1 视频处理
- FFmpeg命令行调用
- 多线程处理
- 临时文件管理
- 进度显示

### 2.2 音频处理
- 音频分离技术
- 音频混合处理
- 音量自动调整
- 格式转换支持

### 2.3 界面设计
- Tkinter界面框架
- 自定义样式设置
- 响应式布局
- 组件状态管理

### 2.4 文件管理
- 文件系统操作
- 临时文件处理
- 配置文件管理
- 路径验证处理

## 3. 注意事项

### 3.1 性能优化
- 使用多线程避免界面卡顿
- 定时更新避免频繁IO
- 合理的缓存机制
- 资源及时释放

### 3.2 兼容性处理
- 支持多种视频格式
- 支持多种音频格式
- 路径兼容性处理
- 编码兼容性处理

### 3.3 错误处理
- 输入验证
- 异常捕获
- 用户提示
- 日志记录

### 3.4 用户体验
- 界面响应及时
- 操作流程简单
- 提示信息清晰
- 处理过程可视

## 项目结构
```
cut-cut/
├── src/                    # 源代码目录
│   ├── main.py            # 主程序入口和GUI实现
│   └── config.json        # 配置文件
├── docs/                   # 文档目录
│   └── implementation.md  # 实现原理文档
├── requirements.txt       # 依赖包列表
├── todo.md               # 项目待办事项
├── README.md             # 项目说明文档
└── LICENSE              # 许可证文件
```

## 核心文件实现原理

### 1. main.py

#### 1.1 类结构
```python
class VideoMixerApp:
    def __init__(self, root: tk.Tk):
        # 初始化GUI应用
```

#### 1.2 主要组件

##### a. GUI界面实现
- 使用tkinter和ttk构建现代化界面
- 界面分为三个主要区域：
  1. 文件夹选择区域
  2. 参数设置区域
  3. 视频列表区域

##### b. 配置管理
- 使用JSON文件存储配置
- 保存和加载以下信息：
  - 输入文件夹路径
  - 输出文件夹路径
  - 音效文件路径

##### c. 视频处理参数
- 支持两种模式：
  1. 手动模式：手动设置片段时长和数量
  2. 自动模式：根据总时长自动计算参数

##### d. 音频处理选项
- 支持三种音频处理方式：
  1. 保留原始音频
  2. 仅保留人声（去除背景音乐）
  3. 完全去除音频
- 支持音效添加：
  1. 不添加音效
  2. 每个片段添加音效
  3. 仅在视频开头添加音效

#### 1.3 核心功能实现

##### a. 视频处理流程
```python
def _process_videos(self, videos, duration, clips, temp_dir, generate_count):
    # 1. 随机选择视频片段
    # 2. 处理每个片段
    # 3. 合并片段
    # 4. 添加音效
    # 5. 清理临时文件
```

##### b. FFmpeg命令说明
1. 视频裁剪和缩放：
```python
cmd = [
    "ffmpeg", "-y",
    "-i", input_path,
    "-t", str(duration),  # 设置片段时长
    "-vf", "scale=w=1080:h=1920:force_original_aspect_ratio=decrease,"  # 缩放到TikTok尺寸
           "pad=1080:1920:(ow-iw)/2:(oh-ih)/2:black",  # 添加黑边填充
    "-c:v", "libx264",    # 使用H.264编码
    "-preset", "medium",  # 编码速度和质量平衡
    "-crf", "18",        # 视频质量设置
    processed_path
]
```

2. 音频处理：
```python
# 人声分离
cmd = [
    "ffmpeg", "-y",
    "-i", processed_path,
    "-af", "pan=stereo|c0=c0,lowpass=3000,highpass=200",  # 音频过滤器
    "-c:v", "copy",
    temp_path
]
```

3. 音效添加：
```python
cmd = [
    "ffmpeg", "-y",
    "-i", processed_path,
    "-i", sound_effect_path,
    "-filter_complex", "[1:a]adelay=0|0[delayed];[0:a][delayed]amix=inputs=2:duration=first",
    "-c:v", "copy",
    output_path
]
```

4. 视频合并：
```python
cmd = [
    "ffmpeg", "-y",
    "-f", "concat",
    "-safe", "0",
    "-i", list_file,
    "-c", "copy",
    merged_path
]
```

#### 1.4 错误处理机制
- 使用try-except捕获所有可能的异常
- 主要处理以下错误：
  1. 文件操作错误
  2. FFmpeg处理错误
  3. 参数验证错误
  4. 配置文件错误

#### 1.5 多线程处理
- 使用threading模块实现后台处理
- 避免GUI卡顿
- 实时更新处理进度

### 2. config.json

#### 2.1 文件结构
```json
{
    "input_folder": "输入文件夹路径",
    "output_folder": "输出文件夹路径",
    "sound_effect_path": "音效文件路径"
}
```

#### 2.2 配置管理
- 程序启动时加载
- 用户修改设置时保存
- 使用UTF-8编码确保中文支持

## 技术要点

### 1. FFmpeg使用
- 视频处理核心功能依赖FFmpeg
- 主要使用功能：
  - 视频裁剪
  - 尺寸调整
  - 音频处理
  - 视频合并

### 2. GUI设计
- 使用ttk主题
- 自定义按钮样式
- 响应式布局

### 3. 文件处理
- 支持多种视频格式
- 临时文件管理
- 自动清理机制

### 4. 性能优化
- 多线程处理
- 内存管理
- 临时文件处理

## 开发注意事项

### 1. 环境要求
- Python 3.x
- FFmpeg安装并添加到系统PATH
- 必要的Python包：
  - tkinter
  - pillow >= 9.0.0

### 2. 代码维护
- 遵循PEP 8编码规范
- 使用类型注解
- 添加必要的注释

### 3. 错误处理
- 所有文件操作都需要错误处理
- FFmpeg命令执行需要异常捕获
- GUI操作需要输入验证

### 4. 测试建议
- 测试不同视频格式
- 测试各种参数组合
- 测试异常情况处理

## 扩展建议

### 1. 功能扩展
- 添加更多视频效果
- 支持更多视频格式
- 添加预览功能

### 2. 性能优化
- 使用GPU加速
- 优化临时文件处理
- 改进音频处理算法

### 3. 界面优化
- 添加进度条
- 优化视频预览
- 添加更多自定义选项 